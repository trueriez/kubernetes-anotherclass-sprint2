pipeline {
    agent any

    tools {
        gradle 'gradle-8.10'
        jdk 'jdk-17'
    }

    parameters {
        // ë°°í¬ í™˜ê²½ ì„ íƒ
        choice(choices: ['dev', 'qa', 'prod'], name: 'PROFILE', description: 'ë°°í¬ í™˜ê²½ ì„ íƒ')
    }

    environment {
        // ë³¸ì¸ì˜ usernameìœ¼ë¡œ í•˜ì‹¤ ë¶„ì€ ìˆ˜ì •í•´ì£¼ì„¸ìš”.
        DOCKERHUB_USERNAME = 'trueriez'
        GITHUB_URL = 'https://github.com/trueriez/kubernetes-anotherclass-sprint2.git'

        APP_VERSION = '1.1.1'
        BUILD_DATE = sh(script: "echo `date +%y%m%d.%d%H%M`", returnStdout: true).trim()
        // ìœ„ì— date í¬ë§· ì˜¤ë¥˜ê°€ ìˆì–´ìš”. %y%m%d.%H%M%Sê°€ ë§ìŠµë‹ˆë‹¤)
        TAG = "${APP_VERSION}-" + "${BUILD_DATE}"

        // ì‹¤ìŠµ ë„˜ë²„ë§
        CLASS_NUM = '2232'
    }

    stages {
        stage('ì†ŒìŠ¤íŒŒì¼ ì²´í¬ì•„ì›ƒ') {
            steps {
                // ì†ŒìŠ¤ì½”ë“œë¥¼ ê°€ì ¸ì˜¬ Github ì£¼ì†Œ
                script {
                    withCredentials([usernamePassword(credentialsId: 'github-credentials', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                        checkout scmGit(
                            branches: [[name: '*/main']],  
                            userRemoteConfigs: [[url: "https://${GIT_USER}:${GIT_PASS}@github.com/trueriez/kubernetes-anotherclass-api-tester.git"]]
                        )
                    }
                }
            }
        }

        stage('ì†ŒìŠ¤ ë¹Œë“œ') {
            steps {
                // 755ê¶Œí•œ í•„ìš” (ìœˆë„ìš°ì—ì„œ Gitìœ¼ë¡œ ì†ŒìŠ¤ ì—…ë¡œë“œì‹œ ê¶Œí•œì€ 644)
                sh "chmod +x ./gradlew"
                sh "gradle clean build"
            }
        }

        stage('ë¦´ë¦¬ì¦ˆíŒŒì¼ ì²´í¬ì•„ì›ƒ') {
            steps {
                checkout scmGit(branches: [[name: '*/main']],
                        extensions: [[$class: 'SparseCheckoutPaths',
                                      sparseCheckoutPaths: [[path: "/${CLASS_NUM}"]]]],
                        userRemoteConfigs: [[url: "${GITHUB_URL}"]])
            }
        }

        stage('ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì—…ë¡œë“œ') {
            steps {
                // jar íŒŒì¼ ë³µì‚¬
                sh "cp ./build/libs/app-0.0.1-SNAPSHOT.jar ./${CLASS_NUM}/build/docker/app-0.0.1-SNAPSHOT.jar"

                script{

                    withCredentials([usernamePassword(credentialsId: 'github-container-credentials', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PAT')]) {
                        sh '''
                            echo "ğŸ“Œ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ (pwd):"
                            pwd  # í˜„ì¬ ìœ„ì¹˜ ì¶œë ¥

                            echo "$GIT_PAT" | docker login ghcr.io -u "$GIT_USER" --password-stdin

                        '''
                    }
                    
                    sh "mkdir -p ./${CLASS_NUM}/build/docker"
                    // ë„ì»¤ ë¹Œë“œ ë° ì—…ë¡œë“œ
                    sh "docker build ./${CLASS_NUM}/build/docker -t ${DOCKERHUB_USERNAME}/api-tester:${TAG}"
                    sh "docker push ${DOCKERHUB_USERNAME}/api-tester:${TAG}"

                    // ë„ì»¤ ì´ë¯¸ì§€ ì‚­ì œ
                    sh "docker rmi ${DOCKERHUB_USERNAME}/api-tester:${TAG}"
                }
            }

            post {
                always {
                    // ë„ì»¤ ë¡œê·¸ì•„ì›ƒ
                    sh "docker logout"
                }
            }
        }
    }
}
